"use strict";
Object.defineProperties(exports, {
  Injector: {get: function() {
      return Injector;
    }},
  __esModule: {value: true}
});
var $__annotations__,
    $__util__,
    $__profiler__,
    $__providers__;
var $__0 = ($__annotations__ = require("./annotations"), $__annotations__ && $__annotations__.__esModule && $__annotations__ || {default: $__annotations__}),
    annotate = $__0.annotate,
    readAnnotations = $__0.readAnnotations,
    hasAnnotation = $__0.hasAnnotation,
    ProvideAnnotation = $__0.Provide,
    TransientScopeAnnotation = $__0.TransientScope;
var $__1 = ($__util__ = require("./util"), $__util__ && $__util__.__esModule && $__util__ || {default: $__util__}),
    isFunction = $__1.isFunction,
    toString = $__1.toString;
var profileInjector = ($__profiler__ = require("./profiler"), $__profiler__ && $__profiler__.__esModule && $__profiler__ || {default: $__profiler__}).profileInjector;
var createProviderFromFnOrClass = ($__providers__ = require("./providers"), $__providers__ && $__providers__.__esModule && $__providers__ || {default: $__providers__}).createProviderFromFnOrClass;
function constructResolvingMessage(resolving, token) {
  if (arguments.length > 1) {
    resolving.push(token);
  }
  if (resolving.length > 1) {
    return (" (" + resolving.map(toString).join(' -> ') + ")");
  }
  return '';
}
var Injector = function Injector() {
  var modules = arguments[0] !== (void 0) ? arguments[0] : [];
  var parentInjector = arguments[1] !== (void 0) ? arguments[1] : null;
  var providers = arguments[2] !== (void 0) ? arguments[2] : new Map();
  var scopes = arguments[3] !== (void 0) ? arguments[3] : [];
  this._cache = new Map();
  this._providers = providers;
  this._parent = parentInjector;
  this._scopes = scopes;
  this._loadModules(modules);
  profileInjector(this, $Injector);
};
var $Injector = Injector;
($traceurRuntime.createClass)(Injector, {
  _collectProvidersWithAnnotation: function(annotationClass, collectedProviders) {
    this._providers.forEach((function(provider, token) {
      if (!collectedProviders.has(token) && hasAnnotation(provider.provider, annotationClass)) {
        collectedProviders.set(token, provider);
      }
    }));
    if (this._parent) {
      this._parent._collectProvidersWithAnnotation(annotationClass, collectedProviders);
    }
  },
  _loadModules: function(modules) {
    for (var $__6 = modules[Symbol.iterator](),
        $__7; !($__7 = $__6.next()).done; ) {
      var module = $__7.value;
      {
        if (isFunction(module)) {
          this._loadFnOrClass(module);
          continue;
        }
        throw new Error('Invalid module!');
      }
    }
  },
  _loadFnOrClass: function(fnOrClass) {
    var annotations = readAnnotations(fnOrClass);
    var token = annotations.provide.token || fnOrClass;
    var provider = createProviderFromFnOrClass(fnOrClass, annotations);
    this._providers.set(token, provider);
  },
  _hasProviderFor: function(token) {
    if (this._providers.has(token)) {
      return true;
    }
    if (this._parent) {
      return this._parent._hasProviderFor(token);
    }
    return false;
  },
  _instantiateDefaultProvider: function(provider, token, resolving, wantPromise, wantLazy) {
    if (!this._parent) {
      this._providers.set(token, provider);
      return this.get(token, resolving, wantPromise, wantLazy);
    }
    for (var $__6 = this._scopes[Symbol.iterator](),
        $__7; !($__7 = $__6.next()).done; ) {
      var ScopeClass = $__7.value;
      {
        if (hasAnnotation(provider.provider, ScopeClass)) {
          this._providers.set(token, provider);
          return this.get(token, resolving, wantPromise, wantLazy);
        }
      }
    }
    return this._parent._instantiateDefaultProvider(provider, token, resolving, wantPromise, wantLazy);
  },
  get: function(token) {
    var resolving = arguments[1] !== (void 0) ? arguments[1] : [];
    var wantPromise = arguments[2] !== (void 0) ? arguments[2] : false;
    var wantLazy = arguments[3] !== (void 0) ? arguments[3] : false;
    var $__4 = this;
    var resolvingMsg = '';
    var provider;
    var instance;
    var injector = this;
    if (token === null || token === undefined) {
      resolvingMsg = constructResolvingMessage(resolving, token);
      throw new Error(("Invalid token \"" + token + "\" requested!" + resolvingMsg));
    }
    if (token === $Injector) {
      if (wantPromise) {
        return Promise.resolve(this);
      }
      return this;
    }
    if (wantLazy) {
      return function createLazyInstance() {
        var lazyInjector = injector;
        if (arguments.length) {
          var locals = [];
          var args = arguments;
          for (var i = 0; i < args.length; i += 2) {
            locals.push((function(ii) {
              var fn = function createLocalInstance() {
                return args[ii + 1];
              };
              annotate(fn, new ProvideAnnotation(args[ii]));
              return fn;
            })(i));
          }
          lazyInjector = injector.createChild(locals);
        }
        return lazyInjector.get(token, resolving, wantPromise, false);
      };
    }
    if (this._cache.has(token)) {
      instance = this._cache.get(token);
      provider = this._providers.get(token);
      if (provider.isPromise && !wantPromise) {
        resolvingMsg = constructResolvingMessage(resolving, token);
        throw new Error(("Cannot instantiate " + toString(token) + " synchronously. It is provided as a promise!" + resolvingMsg));
      }
      if (!provider.isPromise && wantPromise) {
        return Promise.resolve(instance);
      }
      return instance;
    }
    provider = this._providers.get(token);
    if (!provider && isFunction(token) && !this._hasProviderFor(token)) {
      provider = createProviderFromFnOrClass(token, readAnnotations(token));
      return this._instantiateDefaultProvider(provider, token, resolving, wantPromise, wantLazy);
    }
    if (!provider) {
      if (!this._parent) {
        resolvingMsg = constructResolvingMessage(resolving, token);
        throw new Error(("No provider for " + toString(token) + "!" + resolvingMsg));
      }
      return this._parent.get(token, resolving, wantPromise, wantLazy);
    }
    if (resolving.indexOf(token) !== -1) {
      resolvingMsg = constructResolvingMessage(resolving, token);
      throw new Error(("Cannot instantiate cyclic dependency!" + resolvingMsg));
    }
    resolving.push(token);
    var delayingInstantiation = wantPromise && provider.params.some((function(param) {
      return !param.isPromise;
    }));
    var args = provider.params.map((function(param) {
      if (delayingInstantiation) {
        return $__4.get(param.token, resolving, true, param.isLazy);
      }
      return $__4.get(param.token, resolving, param.isPromise, param.isLazy);
    }));
    if (delayingInstantiation) {
      var delayedResolving = resolving.slice();
      resolving.pop();
      return Promise.all(args).then(function(args) {
        try {
          instance = provider.create(args);
        } catch (e) {
          resolvingMsg = constructResolvingMessage(delayedResolving);
          var originalMsg = 'ORIGINAL ERROR: ' + e.message;
          e.message = ("Error during instantiation of " + toString(token) + "!" + resolvingMsg + "\n" + originalMsg);
          throw e;
        }
        if (!hasAnnotation(provider.provider, TransientScopeAnnotation)) {
          injector._cache.set(token, instance);
        }
        return instance;
      });
    }
    try {
      instance = provider.create(args);
    } catch (e) {
      resolvingMsg = constructResolvingMessage(resolving);
      var originalMsg = 'ORIGINAL ERROR: ' + e.message;
      e.message = ("Error during instantiation of " + toString(token) + "!" + resolvingMsg + "\n" + originalMsg);
      throw e;
    }
    if (!hasAnnotation(provider.provider, TransientScopeAnnotation)) {
      this._cache.set(token, instance);
    }
    if (!wantPromise && provider.isPromise) {
      resolvingMsg = constructResolvingMessage(resolving);
      throw new Error(("Cannot instantiate " + toString(token) + " synchronously. It is provided as a promise!" + resolvingMsg));
    }
    if (wantPromise && !provider.isPromise) {
      instance = Promise.resolve(instance);
    }
    resolving.pop();
    return instance;
  },
  getPromise: function(token) {
    return this.get(token, [], true);
  },
  createChild: function() {
    var modules = arguments[0] !== (void 0) ? arguments[0] : [];
    var forceNewInstancesOf = arguments[1] !== (void 0) ? arguments[1] : [];
    var forcedProviders = new Map();
    forceNewInstancesOf.push(TransientScopeAnnotation);
    for (var $__6 = forceNewInstancesOf[Symbol.iterator](),
        $__7; !($__7 = $__6.next()).done; ) {
      var annotation = $__7.value;
      {
        this._collectProvidersWithAnnotation(annotation, forcedProviders);
      }
    }
    return new $Injector(modules, this, forcedProviders, forceNewInstancesOf);
  }
}, {});
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYnMvZGkvaW5qZWN0b3IuanMiLCJAdHJhY2V1ci9nZW5lcmF0ZWQvVGVtcGxhdGVQYXJzZXIvNiIsIkB0cmFjZXVyL2dlbmVyYXRlZC9UZW1wbGF0ZVBhcnNlci80IiwiQHRyYWNldXIvZ2VuZXJhdGVkL1RlbXBsYXRlUGFyc2VyLzIiLCJAdHJhY2V1ci9nZW5lcmF0ZWQvVGVtcGxhdGVQYXJzZXIvMyIsIkB0cmFjZXVyL2dlbmVyYXRlZC9UZW1wbGF0ZVBhcnNlci81IiwiQHRyYWNldXIvZ2VuZXJhdGVkL1RlbXBsYXRlUGFyc2VyLzEiLCJAdHJhY2V1ci9nZW5lcmF0ZWQvVGVtcGxhdGVQYXJzZXIvOCIsIkB0cmFjZXVyL2dlbmVyYXRlZC9UZW1wbGF0ZVBhcnNlci8xMyIsIkB0cmFjZXVyL2dlbmVyYXRlZC9UZW1wbGF0ZVBhcnNlci85IiwiQHRyYWNldXIvZ2VuZXJhdGVkL1RlbXBsYXRlUGFyc2VyLzExIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUEsS0FBSyxpQkFBaUIsQUFBQyxDQUFDLE9BQU07VUNBOUIsRUFBQyxHQUFFLFlDQXFCO0FBQUUscUJBQXdCO0lBQUUsQURBOUIsQ0FBQztBRUF2QixXQUFTLENDQVQsRUFBQyxLQUFJLENEQU8sS0FBRyxBQ0FTLENBQUM7Q0pBeUIsQ0FBQzs7Ozs7U0tBbkQsRUFBQyxrQkFBb0IsQ0FBQSxPQUFNLEFBQUMsaUJBQWtCLENBQ3RDLENBQUEsbUJBQXFCLDRCQUEyQixDQUFBLG1CQUFxQixHQUFLLEVBQUMsT0FBTSxrQkFBbUIsQ0FEOUQsQUFDK0QsQ0FBQztBTkE1RyxXQUFPO0FBQ1Asa0JBQWM7QUFDZCxnQkFBWTtBQUNELG9CQUFnQjtBQUNULDJCQUF1QjtTTUwzQyxFQUFDLFdBQW9CLENBQUEsT0FBTSxBQUFDLFVBQWtCLENBQ3RDLENBQUEsWUFBcUIscUJBQTJCLENBQUEsWUFBcUIsR0FBSyxFQUFDLE9BQU0sV0FBbUIsQ0FEOUQsQUFDK0QsQ0FBQztBTk10RyxhQUFTO0FBQUcsV0FBTztFQUNuQixnQkFBYyxFTVJ0QixFQUFDLGVBQW9CLENBQUEsT0FBTSxBQUFDLGNBQWtCLENBQ3RDLENBQUEsZ0JBQXFCLHlCQUEyQixDQUFBLGdCQUFxQixHQUFLLEVBQUMsT0FBTSxlQUFtQixDQUQ5RCxBQUMrRCxDQUFDO0VOUXRHLDRCQUEwQixFTVRsQyxFQUFDLGdCQUFvQixDQUFBLE9BQU0sQUFBQyxlQUFrQixDQUN0QyxDQUFBLGlCQUFxQiwwQkFBMkIsQ0FBQSxpQkFBcUIsR0FBSyxFQUFDLE9BQU0sZ0JBQW1CLENBRDlELEFBQytELENBQUM7QU5VOUcsT0FBUywwQkFBd0IsQ0FBRSxTQUFRLENBQUcsQ0FBQSxLQUFJLENBQUc7QUFHbkQsS0FBSSxTQUFRLE9BQU8sRUFBSSxFQUFBLENBQUc7QUFDeEIsWUFBUSxLQUFLLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBQztFQUN2QjtBQUFBLEFBRUEsS0FBSSxTQUFRLE9BQU8sRUFBSSxFQUFBLENBQUc7QUFDeEIsV0FBTyxJQUFJLEVBQUMsQ0FBQSxTQUFRLElBQUksQUFBQyxDQUFDLFFBQU8sQ0FBQyxLQUFLLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQSxDQUFDLElBQUUsRUFBQztFQUNyRDtBQUFBLEFBRUEsT0FBTyxHQUFDLENBQUM7QUFDWDtBT3ZCSSxBUHVCSixFT3ZCSSxXUHFDSixTQUFNLFNBQU8sQ0FFQyxBQUFzRSxDQUFHO0lBQXpFLFFBQU0sNkNBQUksR0FBQztJQUFHLGVBQWEsNkNBQUksS0FBRztJQUFHLFVBQVEsNkNBQUksSUFBSSxJQUFFLEFBQUMsRUFBQztJQUFHLE9BQUssNkNBQUksR0FBQztBQUNoRixLQUFHLE9BQU8sRUFBSSxJQUFJLElBQUUsQUFBQyxFQUFDLENBQUM7QUFDdkIsS0FBRyxXQUFXLEVBQUksVUFBUSxDQUFDO0FBQzNCLEtBQUcsUUFBUSxFQUFJLGVBQWEsQ0FBQztBQUM3QixLQUFHLFFBQVEsRUFBSSxPQUFLLENBQUM7QUFFckIsS0FBRyxhQUFhLEFBQUMsQ0FBQyxPQUFNLENBQUMsQ0FBQztBQUUxQixnQkFBYyxBQUFDLENBQUMsSUFBRyxZQUFXLENBQUM7QU8vQ0ssQVBnRHRDLENPaERzQztBQ0F4QyxBQUFJLEVBQUEscUJBQW9DLENBQUE7QUNBeEMsQUFBQyxlQUFjLFlBQVksQ0FBQyxBQUFDO0FUcUQzQixnQ0FBOEIsQ0FBOUIsVUFBZ0MsZUFBYyxDQUFHLENBQUEsa0JBQWlCO0FBQ2hFLE9BQUcsV0FBVyxRQUFRLEFBQUMsRUFBQyxTQUFDLFFBQU8sQ0FBRyxDQUFBLEtBQUksQ0FBTTtBQUMzQyxTQUFJLENBQUMsa0JBQWlCLElBQUksQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFBLEVBQUssQ0FBQSxhQUFZLEFBQUMsQ0FBQyxRQUFPLFNBQVMsQ0FBRyxnQkFBYyxDQUFDLENBQUc7QUFDdkYseUJBQWlCLElBQUksQUFBQyxDQUFDLEtBQUksQ0FBRyxTQUFPLENBQUMsQ0FBQztNQUN6QztBQUFBLElBQ0YsRUFBQyxDQUFDO0FBRUYsT0FBSSxJQUFHLFFBQVEsQ0FBRztBQUNoQixTQUFHLFFBQVEsZ0NBQWdDLEFBQUMsQ0FBQyxlQUFjLENBQUcsbUJBQWlCLENBQUMsQ0FBQztJQUNuRjtBQUFBLEVBQ0Y7QUFLQSxhQUFXLENBQVgsVUFBYSxPQUFNO0FVbkViLFFBQVMsR0FBQSxPQUNBLENWbUVNLE9BQU0sQ1VuRU0sTUFBSyxTQUFTLENBQUMsQUFBQyxFQUFDO0FBQ25DLFdBQWdCLENBQ3BCLEVBQUMsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssR0FBSztRVmlFeEQsT0FBSztBQUFjO0FBRTFCLFdBQUksVUFBUyxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUc7QUFDdEIsYUFBRyxlQUFlLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztBQUMzQixrQkFBUTtRQUNWO0FBQUEsQUFFQSxZQUFNLElBQUksTUFBSSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztNQUNwQztJVXRFSTtBQUFBLEVWdUVOO0FBS0EsZUFBYSxDQUFiLFVBQWUsU0FBUSxDQUFHO0FBRXhCLEFBQUksTUFBQSxDQUFBLFdBQVUsRUFBSSxDQUFBLGVBQWMsQUFBQyxDQUFDLFNBQVEsQ0FBQyxDQUFDO0FBQzVDLEFBQUksTUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLFdBQVUsUUFBUSxNQUFNLEdBQUssVUFBUSxDQUFDO0FBQ2xELEFBQUksTUFBQSxDQUFBLFFBQU8sRUFBSSxDQUFBLDJCQUEwQixBQUFDLENBQUMsU0FBUSxDQUFHLFlBQVUsQ0FBQyxDQUFDO0FBRWxFLE9BQUcsV0FBVyxJQUFJLEFBQUMsQ0FBQyxLQUFJLENBQUcsU0FBTyxDQUFDLENBQUM7RUFDdEM7QUFLQSxnQkFBYyxDQUFkLFVBQWdCLEtBQUksQ0FBRztBQUNyQixPQUFJLElBQUcsV0FBVyxJQUFJLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBRztBQUM5QixXQUFPLEtBQUcsQ0FBQztJQUNiO0FBQUEsQUFFQSxPQUFJLElBQUcsUUFBUSxDQUFHO0FBQ2hCLFdBQU8sQ0FBQSxJQUFHLFFBQVEsZ0JBQWdCLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBQztJQUM1QztBQUFBLEFBRUEsU0FBTyxNQUFJLENBQUM7RUFDZDtBQUdBLDRCQUEwQixDQUExQixVQUE0QixRQUFPLENBQUcsQ0FBQSxLQUFJLENBQUcsQ0FBQSxTQUFRLENBQUcsQ0FBQSxXQUFVLENBQUcsQ0FBQSxRQUFPO0FBRTFFLE9BQUksQ0FBQyxJQUFHLFFBQVEsQ0FBRztBQUNqQixTQUFHLFdBQVcsSUFBSSxBQUFDLENBQUMsS0FBSSxDQUFHLFNBQU8sQ0FBQyxDQUFDO0FBQ3BDLFdBQU8sQ0FBQSxJQUFHLElBQUksQUFBQyxDQUFDLEtBQUksQ0FBRyxVQUFRLENBQUcsWUFBVSxDQUFHLFNBQU8sQ0FBQyxDQUFDO0lBQzFEO0FVaEhJLEFWZ0hKLFFVaEhhLEdBQUEsT0FDQSxDVmtIVSxJQUFHLFFBQVEsQ1VsSEgsTUFBSyxTQUFTLENBQUMsQUFBQyxFQUFDO0FBQ25DLFdBQWdCLENBQ3BCLEVBQUMsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssR0FBSztRVmdIeEQsV0FBUztBQUFtQjtBQUNuQyxXQUFJLGFBQVksQUFBQyxDQUFDLFFBQU8sU0FBUyxDQUFHLFdBQVMsQ0FBQyxDQUFHO0FBQ2hELGFBQUcsV0FBVyxJQUFJLEFBQUMsQ0FBQyxLQUFJLENBQUcsU0FBTyxDQUFDLENBQUM7QUFDcEMsZUFBTyxDQUFBLElBQUcsSUFBSSxBQUFDLENBQUMsS0FBSSxDQUFHLFVBQVEsQ0FBRyxZQUFVLENBQUcsU0FBTyxDQUFDLENBQUM7UUFDMUQ7QUFBQSxNQUNGO0lVbEhJO0FBQUEsQVZxSEosU0FBTyxDQUFBLElBQUcsUUFBUSw0QkFBNEIsQUFBQyxDQUFDLFFBQU8sQ0FBRyxNQUFJLENBQUcsVUFBUSxDQUFHLFlBQVUsQ0FBRyxTQUFPLENBQUMsQ0FBQztFQUNwRztBQUlBLElBQUUsQ0FBRixVQUFJLEtBQUksQUFBdUQ7TUFBcEQsVUFBUSw2Q0FBSSxHQUFDO01BQUcsWUFBVSw2Q0FBSSxNQUFJO01BQUcsU0FBTyw2Q0FBSSxNQUFJOztBQUM3RCxBQUFJLE1BQUEsQ0FBQSxZQUFXLEVBQUksR0FBQyxDQUFDO0FBQ3JCLEFBQUksTUFBQSxDQUFBLFFBQU8sQ0FBQztBQUNaLEFBQUksTUFBQSxDQUFBLFFBQU8sQ0FBQztBQUNaLEFBQUksTUFBQSxDQUFBLFFBQU8sRUFBSSxLQUFHLENBQUM7QUFFbkIsT0FBSSxLQUFJLElBQU0sS0FBRyxDQUFBLEVBQUssQ0FBQSxLQUFJLElBQU0sVUFBUSxDQUFHO0FBQ3pDLGlCQUFXLEVBQUksQ0FBQSx5QkFBd0IsQUFBQyxDQUFDLFNBQVEsQ0FBRyxNQUFJLENBQUMsQ0FBQztBQUMxRCxVQUFNLElBQUksTUFBSSxBQUFDLEVBQUMsa0JBQWlCLEVBQUMsTUFBSSxFQUFDLGdCQUFjLEVBQUMsYUFBVyxFQUFHLENBQUM7SUFDdkU7QUFBQSxBQUdBLE9BQUksS0FBSSxjQUFhLENBQUc7QUFDdEIsU0FBSSxXQUFVLENBQUc7QUFDZixhQUFPLENBQUEsT0FBTSxRQUFRLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztNQUM5QjtBQUFBLEFBRUEsV0FBTyxLQUFHLENBQUM7SUFDYjtBQUFBLEFBR0EsT0FBSSxRQUFPLENBQUc7QUFDWixXQUFPLFNBQVMsbUJBQWlCLENBQUMsQUFBQyxDQUFFO0FBQ25DLEFBQUksVUFBQSxDQUFBLFlBQVcsRUFBSSxTQUFPLENBQUM7QUFFM0IsV0FBSSxTQUFRLE9BQU8sQ0FBRztBQUNwQixBQUFJLFlBQUEsQ0FBQSxNQUFLLEVBQUksR0FBQyxDQUFDO0FBQ2YsQUFBSSxZQUFBLENBQUEsSUFBRyxFQUFJLFVBQVEsQ0FBQztBQUVwQixjQUFTLEdBQUEsQ0FBQSxDQUFBLEVBQUksRUFBQSxDQUFHLENBQUEsQ0FBQSxFQUFJLENBQUEsSUFBRyxPQUFPLENBQUcsQ0FBQSxDQUFBLEdBQUssRUFBQSxDQUFHO0FBQ3ZDLGlCQUFLLEtBQUssQUFBQyxDQUFDLENBQUMsU0FBUyxFQUFDLENBQUc7QUFDeEIsQUFBSSxnQkFBQSxDQUFBLEVBQUMsRUFBSSxTQUFTLG9CQUFrQixDQUFDLEFBQUMsQ0FBRTtBQUN0QyxxQkFBTyxDQUFBLElBQUcsQ0FBRSxFQUFDLEVBQUksRUFBQSxDQUFDLENBQUM7Y0FDckIsQ0FBQztBQUVELHFCQUFPLEFBQUMsQ0FBQyxFQUFDLENBQUcsSUFBSSxrQkFBZ0IsQUFBQyxDQUFDLElBQUcsQ0FBRSxFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFN0MsbUJBQU8sR0FBQyxDQUFDO1lBQ1gsQ0FBQyxBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQztVQUNSO0FBQUEsQUFFQSxxQkFBVyxFQUFJLENBQUEsUUFBTyxZQUFZLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztRQUM3QztBQUFBLEFBRUEsYUFBTyxDQUFBLFlBQVcsSUFBSSxBQUFDLENBQUMsS0FBSSxDQUFHLFVBQVEsQ0FBRyxZQUFVLENBQUcsTUFBSSxDQUFDLENBQUM7TUFDL0QsQ0FBQztJQUNIO0FBQUEsQUFHQSxPQUFJLElBQUcsT0FBTyxJQUFJLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBRztBQUMxQixhQUFPLEVBQUksQ0FBQSxJQUFHLE9BQU8sSUFBSSxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUM7QUFDakMsYUFBTyxFQUFJLENBQUEsSUFBRyxXQUFXLElBQUksQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFDO0FBRXJDLFNBQUksUUFBTyxVQUFVLEdBQUssRUFBQyxXQUFVLENBQUc7QUFDdEMsbUJBQVcsRUFBSSxDQUFBLHlCQUF3QixBQUFDLENBQUMsU0FBUSxDQUFHLE1BQUksQ0FBQyxDQUFDO0FBQzFELFlBQU0sSUFBSSxNQUFJLEFBQUMsRUFBQyxxQkFBcUIsRUFBQyxDQUFBLFFBQU8sQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFBLENBQUMsK0NBQThDLEVBQUMsYUFBVyxFQUFHLENBQUM7TUFDckg7QUFBQSxBQUVBLFNBQUksQ0FBQyxRQUFPLFVBQVUsQ0FBQSxFQUFLLFlBQVUsQ0FBRztBQUN0QyxhQUFPLENBQUEsT0FBTSxRQUFRLEFBQUMsQ0FBQyxRQUFPLENBQUMsQ0FBQztNQUNsQztBQUFBLEFBRUEsV0FBTyxTQUFPLENBQUM7SUFDakI7QUFBQSxBQUVBLFdBQU8sRUFBSSxDQUFBLElBQUcsV0FBVyxJQUFJLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBQztBQUdyQyxPQUFJLENBQUMsUUFBTyxDQUFBLEVBQUssQ0FBQSxVQUFTLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBQSxFQUFLLEVBQUMsSUFBRyxnQkFBZ0IsQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFHO0FBQ2xFLGFBQU8sRUFBSSxDQUFBLDJCQUEwQixBQUFDLENBQUMsS0FBSSxDQUFHLENBQUEsZUFBYyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUMsQ0FBQztBQUNyRSxXQUFPLENBQUEsSUFBRyw0QkFBNEIsQUFBQyxDQUFDLFFBQU8sQ0FBRyxNQUFJLENBQUcsVUFBUSxDQUFHLFlBQVUsQ0FBRyxTQUFPLENBQUMsQ0FBQztJQUM1RjtBQUFBLEFBRUEsT0FBSSxDQUFDLFFBQU8sQ0FBRztBQUNiLFNBQUksQ0FBQyxJQUFHLFFBQVEsQ0FBRztBQUNqQixtQkFBVyxFQUFJLENBQUEseUJBQXdCLEFBQUMsQ0FBQyxTQUFRLENBQUcsTUFBSSxDQUFDLENBQUM7QUFDMUQsWUFBTSxJQUFJLE1BQUksQUFBQyxFQUFDLGtCQUFrQixFQUFDLENBQUEsUUFBTyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUEsQ0FBQyxJQUFHLEVBQUMsYUFBVyxFQUFHLENBQUM7TUFDdkU7QUFBQSxBQUVBLFdBQU8sQ0FBQSxJQUFHLFFBQVEsSUFBSSxBQUFDLENBQUMsS0FBSSxDQUFHLFVBQVEsQ0FBRyxZQUFVLENBQUcsU0FBTyxDQUFDLENBQUM7SUFDbEU7QUFBQSxBQUVBLE9BQUksU0FBUSxRQUFRLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBQSxHQUFNLEVBQUMsQ0FBQSxDQUFHO0FBQ25DLGlCQUFXLEVBQUksQ0FBQSx5QkFBd0IsQUFBQyxDQUFDLFNBQVEsQ0FBRyxNQUFJLENBQUMsQ0FBQztBQUMxRCxVQUFNLElBQUksTUFBSSxBQUFDLEVBQUMsdUNBQXVDLEVBQUMsYUFBVyxFQUFHLENBQUM7SUFDekU7QUFBQSxBQUVBLFlBQVEsS0FBSyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUM7QUFVckIsQUFBSSxNQUFBLENBQUEscUJBQW9CLEVBQUksQ0FBQSxXQUFVLEdBQUssQ0FBQSxRQUFPLE9BQU8sS0FBSyxBQUFDLEVBQUMsU0FBQyxLQUFJO1dBQU0sRUFBQyxLQUFJLFVBQVU7SUFBQSxFQUFDLENBQUM7QUFDNUYsQUFBSSxNQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsUUFBTyxPQUFPLElBQUksQUFBQyxFQUFDLFNBQUMsS0FBSSxDQUFNO0FBRXhDLFNBQUkscUJBQW9CLENBQUc7QUFDekIsYUFBTyxDQUFBLFFBQU8sQUFBQyxDQUFDLEtBQUksTUFBTSxDQUFHLFVBQVEsQ0FBRyxLQUFHLENBQUcsQ0FBQSxLQUFJLE9BQU8sQ0FBQyxDQUFDO01BQzdEO0FBQUEsQUFFQSxXQUFPLENBQUEsUUFBTyxBQUFDLENBQUMsS0FBSSxNQUFNLENBQUcsVUFBUSxDQUFHLENBQUEsS0FBSSxVQUFVLENBQUcsQ0FBQSxLQUFJLE9BQU8sQ0FBQyxDQUFDO0lBQ3hFLEVBQUMsQ0FBQztBQUdGLE9BQUkscUJBQW9CLENBQUc7QUFDekIsQUFBSSxRQUFBLENBQUEsZ0JBQWUsRUFBSSxDQUFBLFNBQVEsTUFBTSxBQUFDLEVBQUMsQ0FBQztBQUV4QyxjQUFRLElBQUksQUFBQyxFQUFDLENBQUM7QUFHZixXQUFPLENBQUEsT0FBTSxJQUFJLEFBQUMsQ0FBQyxJQUFHLENBQUMsS0FBSyxBQUFDLENBQUMsU0FBUyxJQUFHLENBQUc7QUFDM0MsVUFBSTtBQUNGLGlCQUFPLEVBQUksQ0FBQSxRQUFPLE9BQU8sQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO1FBQ2xDLENBQUUsT0FBTyxDQUFBLENBQUc7QUFDVixxQkFBVyxFQUFJLENBQUEseUJBQXdCLEFBQUMsQ0FBQyxnQkFBZSxDQUFDLENBQUM7QUFDMUQsQUFBSSxZQUFBLENBQUEsV0FBVSxFQUFJLENBQUEsa0JBQWlCLEVBQUksQ0FBQSxDQUFBLFFBQVEsQ0FBQztBQUNoRCxVQUFBLFFBQVEsSUFBSSxnQ0FBZ0MsRUFBQyxDQUFBLFFBQU8sQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFBLENBQUMsSUFBRyxFQUFDLGFBQVcsRUFBQyxLQUFJLEVBQUMsWUFBVSxDQUFFLENBQUM7QUFDOUYsY0FBTSxFQUFBLENBQUM7UUFDVDtBQUFBLEFBRUEsV0FBSSxDQUFDLGFBQVksQUFBQyxDQUFDLFFBQU8sU0FBUyxDQUFHLHlCQUF1QixDQUFDLENBQUc7QUFDL0QsaUJBQU8sT0FBTyxJQUFJLEFBQUMsQ0FBQyxLQUFJLENBQUcsU0FBTyxDQUFDLENBQUM7UUFDdEM7QUFBQSxBQU9BLGFBQU8sU0FBTyxDQUFDO01BQ2pCLENBQUMsQ0FBQztJQUNKO0FBQUEsQUFFQSxNQUFJO0FBQ0YsYUFBTyxFQUFJLENBQUEsUUFBTyxPQUFPLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztJQUNsQyxDQUFFLE9BQU8sQ0FBQSxDQUFHO0FBQ1YsaUJBQVcsRUFBSSxDQUFBLHlCQUF3QixBQUFDLENBQUMsU0FBUSxDQUFDLENBQUM7QUFDbkQsQUFBSSxRQUFBLENBQUEsV0FBVSxFQUFJLENBQUEsa0JBQWlCLEVBQUksQ0FBQSxDQUFBLFFBQVEsQ0FBQztBQUNoRCxNQUFBLFFBQVEsSUFBSSxnQ0FBZ0MsRUFBQyxDQUFBLFFBQU8sQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFBLENBQUMsSUFBRyxFQUFDLGFBQVcsRUFBQyxLQUFJLEVBQUMsWUFBVSxDQUFFLENBQUM7QUFDOUYsVUFBTSxFQUFBLENBQUM7SUFDVDtBQUFBLEFBRUEsT0FBSSxDQUFDLGFBQVksQUFBQyxDQUFDLFFBQU8sU0FBUyxDQUFHLHlCQUF1QixDQUFDLENBQUc7QUFDL0QsU0FBRyxPQUFPLElBQUksQUFBQyxDQUFDLEtBQUksQ0FBRyxTQUFPLENBQUMsQ0FBQztJQUNsQztBQUFBLEFBRUEsT0FBSSxDQUFDLFdBQVUsQ0FBQSxFQUFLLENBQUEsUUFBTyxVQUFVLENBQUc7QUFDdEMsaUJBQVcsRUFBSSxDQUFBLHlCQUF3QixBQUFDLENBQUMsU0FBUSxDQUFDLENBQUM7QUFFbkQsVUFBTSxJQUFJLE1BQUksQUFBQyxFQUFDLHFCQUFxQixFQUFDLENBQUEsUUFBTyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUEsQ0FBQywrQ0FBOEMsRUFBQyxhQUFXLEVBQUcsQ0FBQztJQUNySDtBQUFBLEFBRUEsT0FBSSxXQUFVLEdBQUssRUFBQyxRQUFPLFVBQVUsQ0FBRztBQUN0QyxhQUFPLEVBQUksQ0FBQSxPQUFNLFFBQVEsQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0lBQ3RDO0FBQUEsQUFFQSxZQUFRLElBQUksQUFBQyxFQUFDLENBQUM7QUFFZixTQUFPLFNBQU8sQ0FBQztFQUNqQjtBQUdBLFdBQVMsQ0FBVCxVQUFXLEtBQUksQ0FBRztBQUNoQixTQUFPLENBQUEsSUFBRyxJQUFJLEFBQUMsQ0FBQyxLQUFJLENBQUcsR0FBQyxDQUFHLEtBQUcsQ0FBQyxDQUFDO0VBQ2xDO0FBS0EsWUFBVSxDQUFWLFVBQVksQUFBcUM7TUFBckMsUUFBTSw2Q0FBSSxHQUFDO01BQUcsb0JBQWtCLDZDQUFJLEdBQUM7QUFDL0MsQUFBSSxNQUFBLENBQUEsZUFBYyxFQUFJLElBQUksSUFBRSxBQUFDLEVBQUMsQ0FBQztBQUcvQixzQkFBa0IsS0FBSyxBQUFDLENBQUMsd0JBQXVCLENBQUMsQ0FBQztBVWpUOUMsUUFBUyxHQUFBLE9BQ0EsQ1ZrVFUsbUJBQWtCLENVbFRWLE1BQUssU0FBUyxDQUFDLEFBQUMsRUFBQztBQUNuQyxXQUFnQixDQUNwQixFQUFDLENBQUMsTUFBb0IsQ0FBQSxTQUFxQixBQUFDLEVBQUMsQ0FBQyxLQUFLLEdBQUs7UVZnVHhELFdBQVM7QUFBMEI7QUFDMUMsV0FBRyxnQ0FBZ0MsQUFBQyxDQUFDLFVBQVMsQ0FBRyxnQkFBYyxDQUFDLENBQUM7TUFDbkU7SVUvU0k7QUFBQSxBVmlUSixTQUFPLGNBQVksQ0FBQyxPQUFNLENBQUcsS0FBRyxDQUFHLGdCQUFjLENBQUcsb0JBQWtCLENBQUMsQ0FBQztFQUMxRTtLU3pUbUY7O0FUOFRyRiIsImZpbGUiOiJsaWJzL2RpL2luamVjdG9yLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgYW5ub3RhdGUsXG4gIHJlYWRBbm5vdGF0aW9ucyxcbiAgaGFzQW5ub3RhdGlvbixcbiAgUHJvdmlkZSBhcyBQcm92aWRlQW5ub3RhdGlvbixcbiAgVHJhbnNpZW50U2NvcGUgYXMgVHJhbnNpZW50U2NvcGVBbm5vdGF0aW9uXG59IGZyb20gJy4vYW5ub3RhdGlvbnMnO1xuaW1wb3J0IHtpc0Z1bmN0aW9uLCB0b1N0cmluZ30gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7cHJvZmlsZUluamVjdG9yfSBmcm9tICcuL3Byb2ZpbGVyJztcbmltcG9ydCB7Y3JlYXRlUHJvdmlkZXJGcm9tRm5PckNsYXNzfSBmcm9tICcuL3Byb3ZpZGVycyc7XG5cbmZ1bmN0aW9uIGNvbnN0cnVjdFJlc29sdmluZ01lc3NhZ2UocmVzb2x2aW5nLCB0b2tlbikge1xuICAvLyBJZiBhIHRva2VuIGlzIHBhc3NlZCBpbiwgYWRkIGl0IGludG8gdGhlIHJlc29sdmluZyBhcnJheS5cbiAgLy8gV2UgbmVlZCB0byBjaGVjayBhcmd1bWVudHMubGVuZ3RoIGJlY2F1c2UgaXQgY2FuIGJlIG51bGwvdW5kZWZpbmVkLlxuICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHtcbiAgICByZXNvbHZpbmcucHVzaCh0b2tlbik7XG4gIH1cblxuICBpZiAocmVzb2x2aW5nLmxlbmd0aCA+IDEpIHtcbiAgICByZXR1cm4gYCAoJHtyZXNvbHZpbmcubWFwKHRvU3RyaW5nKS5qb2luKCcgLT4gJyl9KWA7XG4gIH1cblxuICByZXR1cm4gJyc7XG59XG5cbi8vIEluamVjdG9yIGVuY2Fwc3VsYXRlIGEgbGlmZSBzY29wZS5cbi8vIFRoZXJlIGlzIGV4YWN0bHkgb25lIGluc3RhbmNlIGZvciBnaXZlbiB0b2tlbiBpbiBnaXZlbiBpbmplY3Rvci5cbi8vXG4vLyBBbGwgdGhlIHN0YXRlIGlzIGltbXV0YWJsZSwgdGhlIG9ubHkgc3RhdGUgY2hhbmdlcyBpcyB0aGUgY2FjaGUuIFRoZXJlIGlzIGhvd2V2ZXIgbm8gd2F5IHRvIHByb2R1Y2UgZGlmZmVyZW50IGluc3RhbmNlIHVuZGVyIGdpdmVuIHRva2VuLiBJbiB0aGF0IHNlbnNlIGl0IGlzIGltbXV0YWJsZS5cbi8vXG4vLyBJbmplY3RvciBpcyByZXNwb25zaWJsZSBmb3I6XG4vLyAtIHJlc29sdmluZyB0b2tlbnMgaW50b1xuLy8gICAtIHByb3ZpZGVyXG4vLyAgIC0gdmFsdWUgKGNhY2hlL2NhbGxpbmcgcHJvdmlkZXIpXG4vLyAtIGRlYWxpbmcgd2l0aCBpc1Byb21pc2Vcbi8vIC0gZGVhbGluZyB3aXRoIGlzTGF6eVxuLy8gLSBsb2FkaW5nIGRpZmZlcmVudCBcInByb3ZpZGVyc1wiIGFuZCBtb2R1bGVzXG5jbGFzcyBJbmplY3RvciB7XG5cbiAgY29uc3RydWN0b3IobW9kdWxlcyA9IFtdLCBwYXJlbnRJbmplY3RvciA9IG51bGwsIHByb3ZpZGVycyA9IG5ldyBNYXAoKSwgc2NvcGVzID0gW10pIHtcbiAgICB0aGlzLl9jYWNoZSA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLl9wcm92aWRlcnMgPSBwcm92aWRlcnM7XG4gICAgdGhpcy5fcGFyZW50ID0gcGFyZW50SW5qZWN0b3I7XG4gICAgdGhpcy5fc2NvcGVzID0gc2NvcGVzO1xuXG4gICAgdGhpcy5fbG9hZE1vZHVsZXMobW9kdWxlcyk7XG5cbiAgICBwcm9maWxlSW5qZWN0b3IodGhpcywgSW5qZWN0b3IpO1xuICB9XG5cblxuICAvLyBDb2xsZWN0IGFsbCByZWdpc3RlcmVkIHByb3ZpZGVycyB0aGF0IGhhcyBnaXZlbiBhbm5vdGF0aW9uLlxuICAvLyBJbmNsdWRpbmcgcHJvdmlkZXJzIGRlZmluZWQgaW4gcGFyZW50IGluamVjdG9ycy5cbiAgX2NvbGxlY3RQcm92aWRlcnNXaXRoQW5ub3RhdGlvbihhbm5vdGF0aW9uQ2xhc3MsIGNvbGxlY3RlZFByb3ZpZGVycykge1xuICAgIHRoaXMuX3Byb3ZpZGVycy5mb3JFYWNoKChwcm92aWRlciwgdG9rZW4pID0+IHtcbiAgICAgIGlmICghY29sbGVjdGVkUHJvdmlkZXJzLmhhcyh0b2tlbikgJiYgaGFzQW5ub3RhdGlvbihwcm92aWRlci5wcm92aWRlciwgYW5ub3RhdGlvbkNsYXNzKSkge1xuICAgICAgICBjb2xsZWN0ZWRQcm92aWRlcnMuc2V0KHRva2VuLCBwcm92aWRlcik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5fcGFyZW50KSB7XG4gICAgICB0aGlzLl9wYXJlbnQuX2NvbGxlY3RQcm92aWRlcnNXaXRoQW5ub3RhdGlvbihhbm5vdGF0aW9uQ2xhc3MsIGNvbGxlY3RlZFByb3ZpZGVycyk7XG4gICAgfVxuICB9XG5cblxuICAvLyBMb2FkIG1vZHVsZXMvZnVuY3Rpb24vY2xhc3Nlcy5cbiAgLy8gVGhpcyBtdXRhdGVzIGB0aGlzLl9wcm92aWRlcnNgLCBidXQgaXQgaXMgb25seSBjYWxsZWQgZHVyaW5nIHRoZSBjb25zdHJ1Y3Rvci5cbiAgX2xvYWRNb2R1bGVzKG1vZHVsZXMpIHtcbiAgICBmb3IgKHZhciBtb2R1bGUgb2YgbW9kdWxlcykge1xuICAgICAgLy8gQSBzaW5nbGUgcHJvdmlkZXIgKGNsYXNzIG9yIGZ1bmN0aW9uKS5cbiAgICAgIGlmIChpc0Z1bmN0aW9uKG1vZHVsZSkpIHtcbiAgICAgICAgdGhpcy5fbG9hZEZuT3JDbGFzcyhtb2R1bGUpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIG1vZHVsZSEnKTtcbiAgICB9XG4gIH1cblxuXG4gIC8vIExvYWQgYSBmdW5jdGlvbiBvciBjbGFzcy5cbiAgLy8gVGhpcyBtdXRhdGVzIGB0aGlzLl9wcm92aWRlcnNgLCBidXQgaXQgaXMgb25seSBjYWxsZWQgZHVyaW5nIHRoZSBjb25zdHJ1Y3Rvci5cbiAgX2xvYWRGbk9yQ2xhc3MoZm5PckNsYXNzKSB7XG4gICAgLy8gVE9ETyh2b2p0YSk6IHNob3VsZCB3ZSBleHBvc2UgcHJvdmlkZXIudG9rZW4/XG4gICAgdmFyIGFubm90YXRpb25zID0gcmVhZEFubm90YXRpb25zKGZuT3JDbGFzcyk7XG4gICAgdmFyIHRva2VuID0gYW5ub3RhdGlvbnMucHJvdmlkZS50b2tlbiB8fCBmbk9yQ2xhc3M7XG4gICAgdmFyIHByb3ZpZGVyID0gY3JlYXRlUHJvdmlkZXJGcm9tRm5PckNsYXNzKGZuT3JDbGFzcywgYW5ub3RhdGlvbnMpO1xuXG4gICAgdGhpcy5fcHJvdmlkZXJzLnNldCh0b2tlbiwgcHJvdmlkZXIpO1xuICB9XG5cblxuICAvLyBSZXR1cm5zIHRydWUgaWYgdGhlcmUgaXMgYW55IHByb3ZpZGVyIHJlZ2lzdGVyZWQgZm9yIGdpdmVuIHRva2VuLlxuICAvLyBJbmNsdWRpbmcgcGFyZW50IGluamVjdG9ycy5cbiAgX2hhc1Byb3ZpZGVyRm9yKHRva2VuKSB7XG4gICAgaWYgKHRoaXMuX3Byb3ZpZGVycy5oYXModG9rZW4pKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fcGFyZW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5fcGFyZW50Ll9oYXNQcm92aWRlckZvcih0b2tlbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gRmluZCB0aGUgY29ycmVjdCBpbmplY3RvciB3aGVyZSB0aGUgZGVmYXVsdCBwcm92aWRlciBzaG91bGQgYmUgaW5zdGFudGlhdGVkIGFuZCBjYWNoZWQuXG4gIF9pbnN0YW50aWF0ZURlZmF1bHRQcm92aWRlcihwcm92aWRlciwgdG9rZW4sIHJlc29sdmluZywgd2FudFByb21pc2UsIHdhbnRMYXp5KSB7XG4gICAgLy8gSW4gcm9vdCBpbmplY3RvciwgaW5zdGFudGlhdGUgaGVyZS5cbiAgICBpZiAoIXRoaXMuX3BhcmVudCkge1xuICAgICAgdGhpcy5fcHJvdmlkZXJzLnNldCh0b2tlbiwgcHJvdmlkZXIpO1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0KHRva2VuLCByZXNvbHZpbmcsIHdhbnRQcm9taXNlLCB3YW50TGF6eSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdGhpcyBpbmplY3RvciBmb3JjZXMgbmV3IGluc3RhbmNlIG9mIHRoaXMgcHJvdmlkZXIuXG4gICAgZm9yICh2YXIgU2NvcGVDbGFzcyBvZiB0aGlzLl9zY29wZXMpIHtcbiAgICAgIGlmIChoYXNBbm5vdGF0aW9uKHByb3ZpZGVyLnByb3ZpZGVyLCBTY29wZUNsYXNzKSkge1xuICAgICAgICB0aGlzLl9wcm92aWRlcnMuc2V0KHRva2VuLCBwcm92aWRlcik7XG4gICAgICAgIHJldHVybiB0aGlzLmdldCh0b2tlbiwgcmVzb2x2aW5nLCB3YW50UHJvbWlzZSwgd2FudExhenkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSBhc2sgcGFyZW50IGluamVjdG9yLlxuICAgIHJldHVybiB0aGlzLl9wYXJlbnQuX2luc3RhbnRpYXRlRGVmYXVsdFByb3ZpZGVyKHByb3ZpZGVyLCB0b2tlbiwgcmVzb2x2aW5nLCB3YW50UHJvbWlzZSwgd2FudExhenkpO1xuICB9XG5cblxuICAvLyBSZXR1cm4gYW4gaW5zdGFuY2UgZm9yIGdpdmVuIHRva2VuLlxuICBnZXQodG9rZW4sIHJlc29sdmluZyA9IFtdLCB3YW50UHJvbWlzZSA9IGZhbHNlLCB3YW50TGF6eSA9IGZhbHNlKSB7XG4gICAgdmFyIHJlc29sdmluZ01zZyA9ICcnO1xuICAgIHZhciBwcm92aWRlcjtcbiAgICB2YXIgaW5zdGFuY2U7XG4gICAgdmFyIGluamVjdG9yID0gdGhpcztcblxuICAgIGlmICh0b2tlbiA9PT0gbnVsbCB8fCB0b2tlbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXNvbHZpbmdNc2cgPSBjb25zdHJ1Y3RSZXNvbHZpbmdNZXNzYWdlKHJlc29sdmluZywgdG9rZW4pO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHRva2VuIFwiJHt0b2tlbn1cIiByZXF1ZXN0ZWQhJHtyZXNvbHZpbmdNc2d9YCk7XG4gICAgfVxuXG4gICAgLy8gU3BlY2lhbCBjYXNlLCByZXR1cm4gaXRzZWxmLlxuICAgIGlmICh0b2tlbiA9PT0gSW5qZWN0b3IpIHtcbiAgICAgIGlmICh3YW50UHJvbWlzZSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvLyBUT0RPKHZvanRhKTogb3B0aW1pemUgLSBubyBjaGlsZCBpbmplY3RvciBmb3IgbG9jYWxzP1xuICAgIGlmICh3YW50TGF6eSkge1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZUxhenlJbnN0YW5jZSgpIHtcbiAgICAgICAgdmFyIGxhenlJbmplY3RvciA9IGluamVjdG9yO1xuXG4gICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7XG4gICAgICAgICAgdmFyIGxvY2FscyA9IFtdO1xuICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzO1xuXG4gICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSArPSAyKSB7XG4gICAgICAgICAgICBsb2NhbHMucHVzaCgoZnVuY3Rpb24oaWkpIHtcbiAgICAgICAgICAgICAgdmFyIGZuID0gZnVuY3Rpb24gY3JlYXRlTG9jYWxJbnN0YW5jZSgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXJnc1tpaSArIDFdO1xuICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgIGFubm90YXRlKGZuLCBuZXcgUHJvdmlkZUFubm90YXRpb24oYXJnc1tpaV0pKTtcblxuICAgICAgICAgICAgICByZXR1cm4gZm47XG4gICAgICAgICAgICB9KShpKSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgbGF6eUluamVjdG9yID0gaW5qZWN0b3IuY3JlYXRlQ2hpbGQobG9jYWxzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBsYXp5SW5qZWN0b3IuZ2V0KHRva2VuLCByZXNvbHZpbmcsIHdhbnRQcm9taXNlLCBmYWxzZSk7XG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHRoZXJlIGlzIGEgY2FjaGVkIGluc3RhbmNlIGFscmVhZHkuXG4gICAgaWYgKHRoaXMuX2NhY2hlLmhhcyh0b2tlbikpIHtcbiAgICAgIGluc3RhbmNlID0gdGhpcy5fY2FjaGUuZ2V0KHRva2VuKTtcbiAgICAgIHByb3ZpZGVyID0gdGhpcy5fcHJvdmlkZXJzLmdldCh0b2tlbik7XG5cbiAgICAgIGlmIChwcm92aWRlci5pc1Byb21pc2UgJiYgIXdhbnRQcm9taXNlKSB7XG4gICAgICAgIHJlc29sdmluZ01zZyA9IGNvbnN0cnVjdFJlc29sdmluZ01lc3NhZ2UocmVzb2x2aW5nLCB0b2tlbik7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGluc3RhbnRpYXRlICR7dG9TdHJpbmcodG9rZW4pfSBzeW5jaHJvbm91c2x5LiBJdCBpcyBwcm92aWRlZCBhcyBhIHByb21pc2UhJHtyZXNvbHZpbmdNc2d9YCk7XG4gICAgICB9XG5cbiAgICAgIGlmICghcHJvdmlkZXIuaXNQcm9taXNlICYmIHdhbnRQcm9taXNlKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoaW5zdGFuY2UpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgcHJvdmlkZXIgPSB0aGlzLl9wcm92aWRlcnMuZ2V0KHRva2VuKTtcblxuICAgIC8vIE5vIHByb3ZpZGVyIGRlZmluZWQgKG92ZXJyaWRkZW4pLCB1c2UgdGhlIGRlZmF1bHQgcHJvdmlkZXIgKHRva2VuKS5cbiAgICBpZiAoIXByb3ZpZGVyICYmIGlzRnVuY3Rpb24odG9rZW4pICYmICF0aGlzLl9oYXNQcm92aWRlckZvcih0b2tlbikpIHtcbiAgICAgIHByb3ZpZGVyID0gY3JlYXRlUHJvdmlkZXJGcm9tRm5PckNsYXNzKHRva2VuLCByZWFkQW5ub3RhdGlvbnModG9rZW4pKTtcbiAgICAgIHJldHVybiB0aGlzLl9pbnN0YW50aWF0ZURlZmF1bHRQcm92aWRlcihwcm92aWRlciwgdG9rZW4sIHJlc29sdmluZywgd2FudFByb21pc2UsIHdhbnRMYXp5KTtcbiAgICB9XG5cbiAgICBpZiAoIXByb3ZpZGVyKSB7XG4gICAgICBpZiAoIXRoaXMuX3BhcmVudCkge1xuICAgICAgICByZXNvbHZpbmdNc2cgPSBjb25zdHJ1Y3RSZXNvbHZpbmdNZXNzYWdlKHJlc29sdmluZywgdG9rZW4pO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHByb3ZpZGVyIGZvciAke3RvU3RyaW5nKHRva2VuKX0hJHtyZXNvbHZpbmdNc2d9YCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLl9wYXJlbnQuZ2V0KHRva2VuLCByZXNvbHZpbmcsIHdhbnRQcm9taXNlLCB3YW50TGF6eSk7XG4gICAgfVxuXG4gICAgaWYgKHJlc29sdmluZy5pbmRleE9mKHRva2VuKSAhPT0gLTEpIHtcbiAgICAgIHJlc29sdmluZ01zZyA9IGNvbnN0cnVjdFJlc29sdmluZ01lc3NhZ2UocmVzb2x2aW5nLCB0b2tlbik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBpbnN0YW50aWF0ZSBjeWNsaWMgZGVwZW5kZW5jeSEke3Jlc29sdmluZ01zZ31gKTtcbiAgICB9XG5cbiAgICByZXNvbHZpbmcucHVzaCh0b2tlbik7XG5cbiAgICAvLyBUT0RPKHZvanRhKTogaGFuZGxlIHRoZXNlIGNhc2VzOlxuICAgIC8vIDEvXG4gICAgLy8gLSByZXF1ZXN0ZWQgYXMgcHJvbWlzZSAoZGVsYXllZClcbiAgICAvLyAtIHJlcXVlc3RlZCBhZ2FpbiBhcyBwcm9taXNlIChiZWZvcmUgdGhlIHByZXZpb3VzIGdldHMgcmVzb2x2ZWQpIC0+IGNhY2hlIHRoZSBwcm9taXNlXG4gICAgLy8gMi9cbiAgICAvLyAtIHJlcXVlc3RlZCBhcyBwcm9taXNlIChkZWxheWVkKVxuICAgIC8vIC0gcmVxdWVzdGVkIGFnYWluIHN5bmMgKGJlZm9yZSB0aGUgcHJldmlvdXMgZ2V0cyByZXNvbHZlZClcbiAgICAvLyAtPiBlcnJvciwgYnV0IGxldCBpdCBnbyBpbnNpZGUgdG8gdGhyb3cgd2hlcmUgZXhhY3RseSBpcyB0aGUgYXN5bmMgcHJvdmlkZXJcbiAgICB2YXIgZGVsYXlpbmdJbnN0YW50aWF0aW9uID0gd2FudFByb21pc2UgJiYgcHJvdmlkZXIucGFyYW1zLnNvbWUoKHBhcmFtKSA9PiAhcGFyYW0uaXNQcm9taXNlKTtcbiAgICB2YXIgYXJncyA9IHByb3ZpZGVyLnBhcmFtcy5tYXAoKHBhcmFtKSA9PiB7XG5cbiAgICAgIGlmIChkZWxheWluZ0luc3RhbnRpYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHBhcmFtLnRva2VuLCByZXNvbHZpbmcsIHRydWUsIHBhcmFtLmlzTGF6eSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLmdldChwYXJhbS50b2tlbiwgcmVzb2x2aW5nLCBwYXJhbS5pc1Byb21pc2UsIHBhcmFtLmlzTGF6eSk7XG4gICAgfSk7XG5cbiAgICAvLyBEZWxheWluZyB0aGUgaW5zdGFudGlhdGlvbiAtIHJldHVybiBhIHByb21pc2UuXG4gICAgaWYgKGRlbGF5aW5nSW5zdGFudGlhdGlvbikge1xuICAgICAgdmFyIGRlbGF5ZWRSZXNvbHZpbmcgPSByZXNvbHZpbmcuc2xpY2UoKTsgLy8gY2xvbmVcblxuICAgICAgcmVzb2x2aW5nLnBvcCgpO1xuXG4gICAgICAvLyBPbmNlIGFsbCBkZXBlbmRlbmNpZXMgKHByb21pc2VzKSBhcmUgcmVzb2x2ZWQsIGluc3RhbnRpYXRlLlxuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGFyZ3MpLnRoZW4oZnVuY3Rpb24oYXJncykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGluc3RhbmNlID0gcHJvdmlkZXIuY3JlYXRlKGFyZ3MpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgcmVzb2x2aW5nTXNnID0gY29uc3RydWN0UmVzb2x2aW5nTWVzc2FnZShkZWxheWVkUmVzb2x2aW5nKTtcbiAgICAgICAgICB2YXIgb3JpZ2luYWxNc2cgPSAnT1JJR0lOQUwgRVJST1I6ICcgKyBlLm1lc3NhZ2U7XG4gICAgICAgICAgZS5tZXNzYWdlID0gYEVycm9yIGR1cmluZyBpbnN0YW50aWF0aW9uIG9mICR7dG9TdHJpbmcodG9rZW4pfSEke3Jlc29sdmluZ01zZ31cXG4ke29yaWdpbmFsTXNnfWA7XG4gICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaGFzQW5ub3RhdGlvbihwcm92aWRlci5wcm92aWRlciwgVHJhbnNpZW50U2NvcGVBbm5vdGF0aW9uKSkge1xuICAgICAgICAgIGluamVjdG9yLl9jYWNoZS5zZXQodG9rZW4sIGluc3RhbmNlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRPRE8odm9qdGEpOiBpZiBhIHByb3ZpZGVyIHJldHVybnMgYSBwcm9taXNlIChidXQgaXMgbm90IGRlY2xhcmVkIGFzIEBQcm92aWRlUHJvbWlzZSksXG4gICAgICAgIC8vIGhlcmUgdGhlIHZhbHVlIHdpbGwgZ2V0IHVud3JhcHBlZCAoYmVjYXVzZSBpdCBpcyByZXR1cm5lZCBmcm9tIGEgcHJvbWlzZSBjYWxsYmFjaykgYW5kXG4gICAgICAgIC8vIHRoZSBhY3R1YWwgdmFsdWUgd2lsbCBiZSBpbmplY3RlZC4gVGhpcyBpcyBwcm9iYWJseSBub3QgZGVzaXJlZCBiZWhhdmlvci4gTWF5YmUgd2UgY291bGRcbiAgICAgICAgLy8gZ2V0IHJpZCBvZmYgdGhlIEBQcm92aWRlUHJvbWlzZSBhbmQganVzdCBjaGVjayB0aGUgcmV0dXJuZWQgdmFsdWUsIHdoZXRoZXIgaXQgaXNcbiAgICAgICAgLy8gYSBwcm9taXNlIG9yIG5vdC5cbiAgICAgICAgcmV0dXJuIGluc3RhbmNlO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGluc3RhbmNlID0gcHJvdmlkZXIuY3JlYXRlKGFyZ3MpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJlc29sdmluZ01zZyA9IGNvbnN0cnVjdFJlc29sdmluZ01lc3NhZ2UocmVzb2x2aW5nKTtcbiAgICAgIHZhciBvcmlnaW5hbE1zZyA9ICdPUklHSU5BTCBFUlJPUjogJyArIGUubWVzc2FnZTtcbiAgICAgIGUubWVzc2FnZSA9IGBFcnJvciBkdXJpbmcgaW5zdGFudGlhdGlvbiBvZiAke3RvU3RyaW5nKHRva2VuKX0hJHtyZXNvbHZpbmdNc2d9XFxuJHtvcmlnaW5hbE1zZ31gO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG5cbiAgICBpZiAoIWhhc0Fubm90YXRpb24ocHJvdmlkZXIucHJvdmlkZXIsIFRyYW5zaWVudFNjb3BlQW5ub3RhdGlvbikpIHtcbiAgICAgIHRoaXMuX2NhY2hlLnNldCh0b2tlbiwgaW5zdGFuY2UpO1xuICAgIH1cblxuICAgIGlmICghd2FudFByb21pc2UgJiYgcHJvdmlkZXIuaXNQcm9taXNlKSB7XG4gICAgICByZXNvbHZpbmdNc2cgPSBjb25zdHJ1Y3RSZXNvbHZpbmdNZXNzYWdlKHJlc29sdmluZyk7XG5cbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGluc3RhbnRpYXRlICR7dG9TdHJpbmcodG9rZW4pfSBzeW5jaHJvbm91c2x5LiBJdCBpcyBwcm92aWRlZCBhcyBhIHByb21pc2UhJHtyZXNvbHZpbmdNc2d9YCk7XG4gICAgfVxuXG4gICAgaWYgKHdhbnRQcm9taXNlICYmICFwcm92aWRlci5pc1Byb21pc2UpIHtcbiAgICAgIGluc3RhbmNlID0gUHJvbWlzZS5yZXNvbHZlKGluc3RhbmNlKTtcbiAgICB9XG5cbiAgICByZXNvbHZpbmcucG9wKCk7XG5cbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH1cblxuXG4gIGdldFByb21pc2UodG9rZW4pIHtcbiAgICByZXR1cm4gdGhpcy5nZXQodG9rZW4sIFtdLCB0cnVlKTtcbiAgfVxuXG5cbiAgLy8gQ3JlYXRlIGEgY2hpbGQgaW5qZWN0b3IsIHdoaWNoIGVuY2Fwc3VsYXRlIHNob3J0ZXIgbGlmZSBzY29wZS5cbiAgLy8gSXQgaXMgcG9zc2libGUgdG8gYWRkIGFkZGl0aW9uYWwgcHJvdmlkZXJzIGFuZCBhbHNvIGZvcmNlIG5ldyBpbnN0YW5jZXMgb2YgZXhpc3RpbmcgcHJvdmlkZXJzLlxuICBjcmVhdGVDaGlsZChtb2R1bGVzID0gW10sIGZvcmNlTmV3SW5zdGFuY2VzT2YgPSBbXSkge1xuICAgIHZhciBmb3JjZWRQcm92aWRlcnMgPSBuZXcgTWFwKCk7XG5cbiAgICAvLyBBbHdheXMgZm9yY2UgbmV3IGluc3RhbmNlIG9mIFRyYW5zaWVudFNjb3BlLlxuICAgIGZvcmNlTmV3SW5zdGFuY2VzT2YucHVzaChUcmFuc2llbnRTY29wZUFubm90YXRpb24pO1xuXG4gICAgZm9yICh2YXIgYW5ub3RhdGlvbiBvZiBmb3JjZU5ld0luc3RhbmNlc09mKSB7XG4gICAgICB0aGlzLl9jb2xsZWN0UHJvdmlkZXJzV2l0aEFubm90YXRpb24oYW5ub3RhdGlvbiwgZm9yY2VkUHJvdmlkZXJzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEluamVjdG9yKG1vZHVsZXMsIHRoaXMsIGZvcmNlZFByb3ZpZGVycywgZm9yY2VOZXdJbnN0YW5jZXNPZik7XG4gIH1cbn1cblxuXG5leHBvcnQge0luamVjdG9yfTtcbiIsIk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGV4cG9ydHMsICRfX3BsYWNlaG9sZGVyX18wKTsiLCJ7Z2V0OiAkX19wbGFjZWhvbGRlcl9fMH0iLCJnZXQgJF9fcGxhY2Vob2xkZXJfXzAoKSB7IHJldHVybiAkX19wbGFjZWhvbGRlcl9fMTsgfSIsIl9fZXNNb2R1bGU6IHRydWUiLCJ7dmFsdWU6ICRfX3BsYWNlaG9sZGVyX18wfSIsIigkX19wbGFjZWhvbGRlcl9fMCA9IHJlcXVpcmUoJF9fcGxhY2Vob2xkZXJfXzEpLCBcbiAgICAgICAgJF9fcGxhY2Vob2xkZXJfXzIgJiYgJF9fcGxhY2Vob2xkZXJfXzMuX19lc01vZHVsZSAmJiAkX19wbGFjZWhvbGRlcl9fNCB8fCB7ZGVmYXVsdDogJF9fcGxhY2Vob2xkZXJfXzV9KSIsInZhciAkX19wbGFjZWhvbGRlcl9fMCA9ICRfX3BsYWNlaG9sZGVyX18xIiwidmFyICRfX3BsYWNlaG9sZGVyX18wID0gJF9fcGxhY2Vob2xkZXJfXzEiLCIoJHRyYWNldXJSdW50aW1lLmNyZWF0ZUNsYXNzKSgkX19wbGFjZWhvbGRlcl9fMCwgJF9fcGxhY2Vob2xkZXJfXzEsICRfX3BsYWNlaG9sZGVyX18yKSIsIlxuICAgICAgICBmb3IgKHZhciAkX19wbGFjZWhvbGRlcl9fMCA9XG4gICAgICAgICAgICAgICAgICRfX3BsYWNlaG9sZGVyX18xW1N5bWJvbC5pdGVyYXRvcl0oKSxcbiAgICAgICAgICAgICAgICAgJF9fcGxhY2Vob2xkZXJfXzI7XG4gICAgICAgICAgICAgISgkX19wbGFjZWhvbGRlcl9fMyA9ICRfX3BsYWNlaG9sZGVyX180Lm5leHQoKSkuZG9uZTsgKSB7XG4gICAgICAgICAgJF9fcGxhY2Vob2xkZXJfXzU7XG4gICAgICAgICAgJF9fcGxhY2Vob2xkZXJfXzY7XG4gICAgICAgIH0iXX0=